name: c9
services:
  cloud-nine-mock-ase:
    hostname: cloud-nine-wallet
    image: rafiki-mock-ase
    build:
      context: ../..
      dockerfile: ./localenv/mock-account-servicing-entity/Dockerfile
    restart: always
    ports:
      - '3030:3030'
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      PORT: 3030
      SEED_FILE_LOCATION: /workspace/seed.yml
      KEY_FILE: /workspace/private-key.pem
    volumes:
      - ../cloud-nine-wallet/seed.yml:/workspace/seed.yml
      - ../cloud-nine-wallet/private-key.pem:/workspace/private-key.pem
    depends_on:
      - cloud-nine-backend
  cloud-nine-backend:
    hostname: cloud-nine-wallet-backend
    image: rafiki-backend
    build:
      context: ../..
      dockerfile: ./packages/backend/Dockerfile
    restart: always
    privileged: true
    ports:
      - '3999:3999'
      - '3001:3001'
      - '3002:3002'
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      ADMIN_PORT: 3001
      CONNECTOR_PORT: 3002
      OPEN_PAYMENTS_PORT: 3999
      DATABASE_URL: postgresql://cloud_nine_wallet_backend:cloud_nine_wallet_backend@host.docker.internal:5432/cloud_nine_wallet_backend
      USE_TIGERBEETLE: ${USE_TIGERBEETLE-false}
      TIGERBEETLE_CLUSTER_ID: ${TIGERBEETLE_CLUSTER_ID-0}
      TIGERBEETLE_REPLICA_ADDRESSES: ${TIGERBEETLE_REPLICA_ADDRESSES-''}
      AUTH_SERVER_GRANT_URL: http://host.docker.internal:3006
      AUTH_SERVER_INTROSPECTION_URL: http://host.docker.internal:3007
      ILP_ADDRESS: test.cloud-nine-wallet
      STREAM_SECRET: BjPXtnd00G2mRQwP/8ZpwyZASOch5sUXT5o0iR5b5wU=
      PUBLIC_HOST: http://host.docker.internal:3999
      OPEN_PAYMENTS_URL: http://host.docker.internal:3999
      WEBHOOK_URL: http://host.docker.internal:3030/webhooks
      EXCHANGE_RATES_URL: http://host.docker.internal:3030/rates
      REDIS_URL: redis://host.docker.internal:6379/0
      PAYMENT_POINTER_URL: https://host.docker.internal:3999/.well-known/pay
    depends_on:
      - shared-database
      - shared-redis
  cloud-nine-auth:
    image: rafiki-auth
    build:
      context: ../..
      dockerfile: ./packages/auth/Dockerfile
    restart: always
    ports:
      - '3003:3003'
      - '3006:3006'
    environment:
      NODE_ENV: development
      AUTH_DATABASE_URL: postgresql://cloud_nine_wallet_auth:cloud_nine_wallet_auth@host.docker.internal:5432/cloud_nine_wallet_auth
    depends_on:
      - shared-database
  cloud-nine-signatures:
    hostname: cloud-nine-wallet-signatures
    image: rafiki-postman-signatures
    build:
      context: ../..
      dockerfile: ./localenv/local-http-signatures/Dockerfile
    restart: always
    ports:
      - '3040:3000'
    environment:
      KEY_FILE: /workspace/private-key.pem
    volumes:
      - ../cloud-nine-wallet/private-key.pem:/workspace/private-key.pem
  shared-database:
    image: 'postgres:15' # use latest official postgres version
    restart: unless-stopped
    volumes:
      - database-data:/var/lib/postgresql/data/ # persist data even if container shuts down
      - ../cloud-nine-wallet/dbinit.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - '5432:5432'
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: postgres
  shared-redis:
    image: 'redis:7'
    ports:
      - '6379:6379'
    expose:
      - '6379'
    restart: unless-stopped
  cloud-nine-admin:
    hostname: cloud-nine-wallet-admin
    image: rafiki-frontend
    build:
      context: ../..
      dockerfile: ./packages/frontend/Dockerfile
    restart: always
    ports:
      - '3010:3010'
    environment:
      PORT: 3010
      GRAPHQL_URL: http://host.docker.internal:3001/graphql
      OPEN_PAYMENTS_URL: https://host.docker.internal:3999/
    depends_on:
      - cloud-nine-backend

volumes:
  database-data: # named volumes can be managed easier using docker-compose
